{% extends "ccd/base.html" %}
{%load static%}

{% block head %}

<!-- style for the check-box only -->
<style>

@keyframes click-wave {
  0% {
    height: 40px;
    width: 40px;
    opacity: 0.35;
    position: relative;
  }
  100% {
    height: 200px;
    width: 200px;
    margin-left: -80px;
    margin-top: -80px;
    opacity: 0;
  }
}

#myonoffswitch {
  -webkit-appearance: none;
  -moz-appearance: none;
  -ms-appearance: none;
  -o-appearance: none;
  appearance: none;
  position: relative;
  top: 13.33333px;
  right: 0;
  bottom: 0;
  left: 40%;
  height: 40px;
  width: 40px;
  transition: all 0.15s ease-out 0s;
  background: #cbd1d8;
  border: none;
  color: #fff;
  cursor: pointer;
  display: inline-block;
  margin-right: 0.5rem;
  outline: none;
  position: relative;
  z-index: 1000;
}
#myonoffswitch:hover {
  background: #9faab7;
}
#myonoffswitch:checked {
  background: #f0ad4e;
}
#myonoffswitch:checked::before {
  height: 40px;
  width: 40px;
  position: absolute;
  content: 'âœ”';
  display: inline-block;
  font-size: 26.66667px;
  text-align: center;
  line-height: 40px;
}
#myonoffswitch:checked::after {
  -webkit-animation: click-wave 0.65s;
  -moz-animation: click-wave 0.65s;
  animation: click-wave 0.65s;
  background: #f0ad4e;
  content: '';
  display: block;
  position: relative;
  z-index: 100;
}
#mymyonoffswitch{
  margin-left: 50%;
  border-radius: 50%;
}
#myonoffswitch::after {
  border-radius: 70%;
}

</style>

<style >
.loader {
border: 4px solid #f3f3f3; /* Light grey */
border-top: 4px solid #3498db; /* Blue */
border-radius: 50%;
width: 25px;
height: 25px;
animation: spin .4s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
</style>

{% endblock head %}
{% block content %}







<div class="row ">
  <div class="col">
    <p>
      <!-- BUTTON TO TRIGGER THE ACTION -->
      <button type="button"
             class="btn btn-info js-create-student-btn"
             data-url="{% url 'ccd:student_create' %}"
              data-toggle="tooltip" data-placement="top" title="Add a new student">
       <i class="fas fa-user-plus mr-1"></i>
       Add Student
     </button>
    </p>

  </div>
  <div class="col">
       <div class="float-right"  id="searchbox">
         <input class="form-control" id="searchbox" type="text" placeholder="Type to search..." />
       </div>
  </div>
</div>
  <div class="row">

    <div class="col-3">
      <div class="form-group">
          <label for="branch">Placed</label>
          <select class="form-control" id="placed_filter">
            <option selected="true"
             value = "all">Both</option>
            <option value='True'>Placed</option>
            <option value="False">Not Placed</option>
          </select>
      </div>
  </div>



  <div class="col-3">
    <div class="form-group">
        <label for="branch">Branch</label>
        <select class="form-control" id="branch_filter">
          <option selected="true"
          value = "all">All</option>
        </select>
    </div>
  </div>
  <div class="col-3">
    <div class="form-group">
        <label for="branch">Program</label>
        <select class="form-control" id="program_filter">
          <option selected="true"
          value = "all">All</option>
          <option value="B.Tech">B.Tech</option>
          <option value="B.Des">B.Des</option>
          <option value="M.Tech">M.Tech</option>
          <option value="M.Des">M.Des</option>
          <option value="M.Sc">M.Sc</option>
          <option value="Phd">Phd</option>
          <option value="Others">Others</option>
        </select>
    </div>
  </div>

  <div class="col-3">
      <div class="form-group">
          <label for="SortBy">Sort By</label>
          <select class="form-control" id="sort">
              <option selected="true" value='roll'>Roll No</option>
              <option value='name'>Name</option>
              <option value='programs'>Program</option>
              <option value='branch'>Branch</option>
              <option value='day'>Day</option>
              <option value='company'>Company</option>
              <option value='placed'>Placed</option>
              <option value='profile'>Profile</option>
              <option value='sector'>Sector</option>
              <option value='slot'>Slot</option>
          </select>

    </div>
  </div>

</div>
  <!-- THE MODAL WE WILL BE USING -->
  <div class="modal fade " id="modal-student">
    <div class="modal-dialog modal-lg " role="document">
      <div class="modal-content bg-light">
      </div>
    </div>
  </div>


<!-- TABLE FOR ALL STUDENTS -->

<div class="row">
  <div class="col">
  <div id="tableLength" class="float-left">
  </div>
    </div>
  <div class="col">
  <div id="dtbuttons" class="float-right">
  </div>
  </div>

</div>

<div class="table-responsive-lg">
  <table class="table table-striped table-bordered table-sm w-auto table-fixed " cellspacing="0" width="100%" id="student-table" style="overflow-x: scroll;">
    <thead class="bg-info">
      <tr>
        <th>Name</th>
        <th>Roll No.</th>
        <th>Program</th>
        <th>Branch</th>
        <th>Day</th>
        <th>Company</th>
        <th>Placed</th>
        <th>Profile</th>
        <th>Sector</th>
        <th>Slot</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>

      {% include "ccd/partial_student_list.html" %}

    </tbody>
  </table>
</div>

<!-- Card -->
<div class="card promoting-card mt-5">

  <!-- Card content -->
  <div class="card-body d-flex flex-row">

    <!-- Avatar -->

    <!-- Content -->
    <div>

      <!-- Title -->
      <h4 class="card-title font-weight-bold mb-2"></h4>
      <a class="btn btn-bg btn-success red-text p-1 my-1 mr-0 mml-1 collapsed" data-toggle="collapse" href="#collapseContent" aria-expanded="false" aria-controls="collapseContent">Update Database</a>

      <!-- Subtitle -->
      <p class="card-text"></p>

    </div>

  </div>

  <!-- Card image -->
  <div class="view overlay">
    <!-- <img class="card-img-top rounded-0" src="" alt="Card image cap"> -->
    <a href="#!">
      <div class="mask rgba-white-slight"></div>
    </a>
  </div>

  <!-- Card content -->
  <div class="card-body">

    <div class="collapse-content">

      <!-- Text -->
      <div class=" collapse" id="collapseContent">
        <p class="" ></p>
        {# <label for="fileUpload">Upload the csv file!</label> #}
        <input type="file" name="fileUpload" id="fileUpload">
        <button type="button" class="btn btn-warning" id="data_btn" disabled> proceed</button>
        <div class="" style="display: flex;justify-content: center;">
           <div id="data-btn-text" class="p-4" hidden><div class="loader"></div></div>
        </div>



        <div class="mt-3 " id="data-table" hidden >
          <div class="table-responsive">
            <table class="table table-striped table-bordered table-sm w-auto table-fixed " cellspacing="0" width="100%" id="csv-data-table" style="overflow-x: scroll;">
              <thead class="bg-info" >
                <tr id="csv_file_headings">

                </tr>
              </thead>

              <tbody id="csv_file_data">

              </tbody>
            </table>
          </div>
        </div>
        <div class="form-group">
            <label for="update_type">Update Type</label>
            <select class="form-control" id="update_type" disabled>
              <option selected="false" >Choose option</option>
              <option value="1">Update already existed students </option>
              <option value="2">Add new students</option>
              <option value ="3">Both</option>
            </select>
        </div>
        <button type="button" class="btn btn-danger" id="database-update-btn"disabled>Update</button>
        <div class="" style="display: flex;justify-content: center;">
           <div id="update-loader-text" class="p-4" hidden>
             <div class="loader"></div>
             <div class="">
             </div>
           </div>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- Card -->


{% endblock content %}
{% block extrascripts %}

<script type="text/javascript">

    $(function () {
        $("#data_btn").on("click", function () {
          // $("#data-btn-text").html('<i class="fa fa-spinner fa-spin"></i>Processing');
          $("#csv_file_data").html('');
          $("#csv_file_headings").html('');
            var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
            if (regex.test($("#fileUpload").val().toLowerCase())) {
                if (typeof (FileReader) != "undefined") {

                  $("#data_btn").prop('disabled',true);
                  $("#data-table").prop('hidden',true);
                  $("#data-btn-text").prop('hidden',false);

                    var reader = new FileReader();
                    reader.onload = function (e) {
                        // spliting all rows
                        var rows = e.target.result.split("\n");

                        // creating headings html
                        var headings = rows[0].split(",");
                        headings_html= "";
                        for(var i =0;i<headings.length;i++)
                          headings_html+="<td>"+headings[i]+"</td>";
                        // update the heading html

                        $("#csv_file_headings").html(headings_html);

                        // now creating html for table data
                        table_data_html ="";
                        for (var i = 1; i < rows.length; i++) {
                            table_data_html+="<tr>";
                            var cells = rows[i].split(",");
                            for (var j = 0; j < headings.length; j++) {
                              var t;
                              if(cells[j]==null)
                                t="";
                              else t =cells[j];
                                table_data_html+="<td>"+t+"</td>";
                            }
                            table_data_html+="</tr>";
                        }
                        // update table data

                        $("#csv_file_data").html(table_data_html);

                        // now add pagination to the table
                        $('#csv-data-table').dataTable().fnDestroy();
                        $('#csv-data-table').DataTable(
                        {
                          dom: 'Blfrtip',
                          pagingType: "full_numbers",
                          // ordering: false,
                          fixedColumns: true,
                        })
                    }
                    reader.readAsText($("#fileUpload")[0].files[0]);

                    $('#update_type').prop('disabled',false);
                } else {
                    alert("This browser does not support HTML5.");
                }
            } else {
                alert("Please upload a valid CSV file.");
            }
            myVar = setTimeout(dataProccessingDone, 3000);

        });
    });
    var dataProccessingDone = function()
    {
      $("#data-btn-text").prop('hidden',true);
      $("#data-table").prop('hidden',false);
      $("#data_btn").prop('disabled',false);

    }
    var inputChanged = function()
    {
      $('#update_type').prop('disabled',true);
      $('#database-update-btn').prop('disabled',true);
      var k = $("#fileUpload")[0].files[0];
      console.log("input changed");
      if(k)
      {
        $('#data_btn').prop('disabled',false);
        console.log("input found!!");
      }
      else {
        $('#data_btn').prop('disabled',true);
        console.log("no input");
      }
    }
    var update_option_changed = function()
    {
        $('#database-update-btn').prop('disabled',false);
    }

    var update_database = function()
    {
      $('#database-update-btn').prop('disabled',true);
      $('#update-loader-text').prop('hidden',false);
      $('#data_btn').prop('disabled',true);
      $("#fileUpload").prop('disabled',true);
      $('#update_type').prop('disabled',true);

      var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
      if (regex.test($("#fileUpload").val().toLowerCase())) {
          if (typeof (FileReader) != "undefined") {
              var reader = new FileReader();
              reader.onload = function (e) {
                  // spliting all rows
                  var rows = e.target.result.split("\n");

                  // creating headings
                  var headings = rows[0].split(",");
                  var data_list =[];
                  for (var i = 1; i < rows.length; i++) {
                      var cells = rows[i].split(",");
                      data_list[i-1]=cells;
                  }
                  console.log(headings);
                  console.log(data_list);

                  $.ajax({
                    contentType: 'application/json; charset=utf-8',
                    url:'/ccd/ajax/update-database',
                    type: 'POST',
                    data :JSON.stringify({'headings':headings,'data_list':data_list,'csrfmiddlewaretoken': '{{ csrf_token }}'}),
                    dataType: 'json',

                    success: function(data)
                    {
                      if(data.success)
                      {
                        console.log("success!");
                      }
                      else {
                        console.log("error!");
                      }
                    }
                    });
                  var ss = setTimeout(reset,3000);
              }
              reader.readAsText($("#fileUpload")[0].files[0]);

              $('#update_type').prop('disabled',false);
          } else {
              alert("This browser does not support HTML5.");
          }
      } else {
          alert("Please upload a valid CSV file.");
      }

    }

    var reset = function()
    {
      $('#update-loader-text').prop('hidden',true);
      $('#data_btn').prop('disabled',false);
      $("#fileUpload").prop('disabled',false);
      $('#csv-data-table').dataTable().fnDestroy();
      $("#csv_file_data").html('');
      $("#csv_file_headings").html('');
    }
    $('#fileUpload').on('change',inputChanged);
    $('#update_type').on('change',update_option_changed);
    $('#database-update-btn').on('click',update_database);


</script>
{% endblock %}
